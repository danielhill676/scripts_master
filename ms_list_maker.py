text = """ESO137          2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X2b8/group.uid___A001_X1465_X2b9/member.uid___A001_X1465_X2ba/calibrated/uid___A002_Xe1d2cb_X10ce5.ms.split.cal
#
ESO021          2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X2b4/group.uid___A001_X1465_X2b5/member.uid___A001_X1465_X2b6/calibrated/uid___A002_Xe1f219_X5184.ms
#
MCG514          2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X2bc/group.uid___A001_X1465_X2bd/member.uid___A001_X1465_X2be/calibrated/uid___A002_Xe1baa0_X46fe.ms
MCG514          2019.1.01742.S  all 12m 2   12m/2019.1.01742.S/science_goal.uid___A001_X1465_X2bc/group.uid___A001_X1465_X2bd/member.uid___A001_X1465_X2c0/calibrated/uid___A002_Xe3da01_X1729.ms
#
MCG630          2017.1.00236.S  all 12m 1   2017.1.00236.S/science_goal.uid___A001_X1296_X8f1/group.uid___A001_X1296_X8f2/member.uid___A001_X1296_X8f3/calibrated/uid___A002_Xc86fe5_X57c6.ms

NGC1315         2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X294/group.uid___A001_X1465_X295/member.uid___A001_X1465_X296/calibrated/uid___A002_Xe1baa0_X2e12.ms
NGC1315         2019.1.01742.S  all 12m 2   12m/2019.1.01742.S/science_goal.uid___A001_X1465_X294/group.uid___A001_X1465_X295/member.uid___A001_X1465_X298/calibrated/uid___A002_Xe3da01_X76b.ms

# 12m directory is actually total power
NGC1365         2021.1.01150.S  all 12m 1   12m_1/2021.1.01150.S/science_goal.uid___A001_X1590_Xe57/group.uid___A001_X1590_Xe58/member.uid___A001_X1590_Xe59/calibrated/uid___A002_Xfb5463_X692f.ms
NGC1365         2013.1.01161.S  all 12m 2   12m_2/2013.1.01161.S/science_goal.uid___A001_X12f_X31f/group.uid___A001_X12f_X320/member.uid___A001_X12f_X321/calibrated/uid___A002_Xa7a216_X21ce.ms.split.cal
NGC1365         2021.1.01150.S  all 12m 3   12m_3/2021.1.01150.S/science_goal.uid___A001_X1590_Xe57/group.uid___A001_X1590_Xe58/member.uid___A001_X1590_Xe5b/calibrated/uid___A002_Xf75b8f_X4a3d.ms
NGC1365         2013.1.01161.S  all 12m 4   12m_4/2013.1.01161.S/science_goal.uid___A001_X12f_X315/group.uid___A001_X12f_X316/member.uid___A001_X12f_X319/calibrated/trimmed_uid___A002_X97fa9e_Xc3d.ms.split.cal
NGC1365         2013.1.01161.S  all 12m 5   12m_4/2013.1.01161.S/science_goal.uid___A001_X12f_X315/group.uid___A001_X12f_X316/member.uid___A001_X12f_X319/calibrated/trimmed_uid___A002_X9d355b_X538.ms.split.cal

NGC1947         2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X29a/group.uid___A001_X1465_X29b/member.uid___A001_X1465_X29c/calibrated/uid___A002_Xe1baa0_X3bc9.ms

NGC2775        2017.1.00886.L  all 12m 1   12m/2017.1.00886.L/science_goal.uid___A001_X1284_X2813/group.uid___A001_X1284_X2814/member.uid___A001_X1284_X2815/calibrated/trimmed_uid___A002_Xcccc19_X384.ms.split.cal

NGC2992         2017.1.00236.S  all 12m 1   2017.1.00236.S/science_goal.uid___A001_X1296_X8ed/group.uid___A001_X1296_X8ee/member.uid___A001_X1296_X8ef/calibrated/trimmed_uid___A002_Xc89480_X1a40.ms
NGC2992         2021.1.01150.S  all 12m 2   12m/2021.1.01150.S/science_goal.uid___A001_X1590_Xe6b/group.uid___A001_X1590_Xe6c/member.uid___A001_X1590_Xe6f/calibrated/uid___A002_Xf6c53e_Xef7.ms
NGC2992         2017.1.01439.S  all 12m 3   12m_1/2017.1.01439.S/science_goal.uid___A001_X1296_X630/group.uid___A001_X1296_X631/member.uid___A001_X1296_X632/calibrated/uid___A002_Xcaca82_X46e.ms
NGC2992         2021.1.01150.S  all 12m 4   12m_2/2021.1.01150.S/science_goal.uid___A001_X1590_Xe6b/group.uid___A001_X1590_Xe6c/member.uid___A001_X1590_Xe6d/calibrated/uid___A002_Xf38bf9_X19f0.ms

NGC3175         2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X29e/group.uid___A001_X1465_X29f/member.uid___A001_X1465_X2a0/calibrated/uid___A002_Xe1baa0_X556a.ms
NGC3175         2019.1.01742.S  all 12m 2   12m/2019.1.01742.S/science_goal.uid___A001_X1465_X29e/group.uid___A001_X1465_X29f/member.uid___A001_X1465_X2a2/calibrated/uid___A002_Xe3a5fd_X85d5.ms

NGC3351         2023.1.01182.S  all 12m 1   12m/2023.1.01182.S/science_goal.uid___A001_X3621_X13ed/group.uid___A001_X3621_X13ee/member.uid___A001_X3621_X13ef/calibrated/uid___A002_X110a1a2_X2ad5b.ms
NGC3351         2023.1.01182.S  all 12m 2   12m/2023.1.01182.S/science_goal.uid___A001_X3621_X13ed/group.uid___A001_X3621_X13ee/member.uid___A001_X3621_X13ef/calibrated/uid___A002_X110fd13_X9858.ms

NGC3749         2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X2aa/group.uid___A001_X1465_X2ab/member.uid___A001_X1465_X2ac/calibrated/uid___A002_Xe230a1_X42af.ms
NGC3749         2019.1.01742.S  all 12m 2   12m/2019.1.01742.S/science_goal.uid___A001_X1465_X2aa/group.uid___A001_X1465_X2ab/member.uid___A001_X1465_X2ae/calibrated/uid___A002_Xe3a5fd_X9030.ms

NGC4224         2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X2b0/group.uid___A001_X1465_X2b1/member.uid___A001_X1465_X2b2/calibrated/uid___A002_Xe230a1_X470f.ms

NGC4254         2023.1.01182.S  all 12m 2   12m_2/2023.1.01182.S/science_goal.uid___A001_X3621_X13f5/group.uid___A001_X3621_X13f6/member.uid___A001_X3621_X13f7/calibrated/uid___A002_X110fd13_X1703d_targets_line.ms
NGC4254         2023.1.01182.S  all 12m 3   12m_2/2023.1.01182.S/science_goal.uid___A001_X3621_X13f5/group.uid___A001_X3621_X13f6/member.uid___A001_X3621_X13f7/calibrated/uid___A002_X110fd13_X17d7f_targets_line.ms
NGC4254         2023.1.01182.S  all 12m 4   12m_2/2023.1.01182.S/science_goal.uid___A001_X3621_X13f5/group.uid___A001_X3621_X13f6/member.uid___A001_X3621_X13f7/calibrated/uid___A002_X110fd13_X9d55_targets_line.ms
NGC4254         2023.1.01182.S  all 12m 5   12m_2/2023.1.01182.S/science_goal.uid___A001_X3621_X13f5/group.uid___A001_X3621_X13f6/member.uid___A001_X3621_X13f7/calibrated/uid___A002_X11840b8_Xb9a_targets_line.ms
NGC4254         2023.1.01182.S  all 12m 6   12m_2/2023.1.01182.S/science_goal.uid___A001_X3621_X13f5/group.uid___A001_X3621_X13f6/member.uid___A001_X3621_X13f7/calibrated/uid___A002_X118bf6a_X794_targets_line.ms

NGC4260         2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X268/group.uid___A001_X1465_X269/member.uid___A001_X1465_X26a/calibrated/uid___A002_Xe230a1_X4aac.ms
NGC4260         2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X268/group.uid___A001_X1465_X269/member.uid___A001_X1465_X26a/calibrated/uid___A002_Xe230a1_X48cb.ms
#

#NGC4593         2018.1.00978.S  all 12m 1   2018.1.00978.S/science_goal.uid___A001_X133d_X279c/group.uid___A001_X133d_X279d/member.uid___A001_X133d_X279e/calibrated/uid___A002_Xde0eb4_Xf5.ms
NGC4593         2017.1.00236.S  all 12m 1   12m/2017.1.00236.S/science_goal.uid___A001_X1296_X901/group.uid___A001_X1296_X902/member.uid___A001_X1296_X903/calibrated/trimmed_uid___A002_Xc8b2b0_X4fbf.ms
NGC4593         2017.1.00236.S  all 12m 2   12m/2017.1.00236.S/science_goal.uid___A001_X1296_X901/group.uid___A001_X1296_X902/member.uid___A001_X1296_X903/calibrated/trimmed_uid___A002_Xc8b2b0_X5659.ms

NGC5128         2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X276/group.uid___A001_X1465_X277/member.uid___A001_X1465_X278/calibrated/uid___A002_Xe1f219_X6a4d.ms

NGC5728         2015.1.00086.S  all 12m 1   2015.1.00086.S/science_goal.uid___A001_X2fe_X66f/group.uid___A001_X2fe_X670/member.uid___A001_X2fe_X671/calibrated/uid___A002_Xb2f730_X6358.ms.split.cal

NGC5921         2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X276/group.uid___A001_X1465_X277/member.uid___A001_X1465_X278/calibrated/uid___A002_Xe1f219_X6a4d.ms

NGC7172         2018.1.00248.S  all 12m 1   2018.1.00248.S_copy/science_goal.uid___A001_X133d_X8e5/group.uid___A001_X133d_X8e6/member.uid___A001_X133d_X8e7/calibrated/uid___A002_Xe0be64_X13fb.ms
NGC7172         2018.1.00248.S  all 12m 2   2018.1.00248.S_copy/science_goal.uid___A001_X133d_X8e5/group.uid___A001_X133d_X8e6/member.uid___A001_X133d_X8e7/calibrated/uid___A002_Xe0740c_X2a5a.ms
NGC7172         2018.1.00248.S  all 12m 3   2018.1.00248.S_copy/science_goal.uid___A001_X133d_X8e5/group.uid___A001_X133d_X8e6/member.uid___A001_X133d_X8e7/calibrated/uid___A002_Xe0be64_X13fb.ms

NGC7213         2012.1.00474.S  all 12m 1   2012.1.00474.S/science_goal.uid___A002_X5d7935_X291/group.uid___A002_X5d7935_X292/member.uid___A002_X5d7935_X293/calibrated/uid___A002_X829c4c_Xb7f.ms.split.cal

NGC7727         2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X27e/group.uid___A001_X1465_X27f/member.uid___A001_X1465_X280/calibrated/uid___A002_Xe1baa0_X1de6.ms
NGC7727         2019.1.01742.S  all 12m 2   12m/2019.1.01742.S/science_goal.uid___A001_X1465_X27e/group.uid___A001_X1465_X27f/member.uid___A001_X1465_X282/calibrated/uid___A002_Xe3da01_X17f.ms
NGC7727         2022.1.01262.S  all 12m 3   12m_1/2022.1.01262.S/science_goal.uid___A001_X2d20_X137e/group.uid___A001_X2d20_X137f/member.uid___A001_X2d20_X1380/calibrated/uid___A002_X1035744_X798d.ms
NGC7727         2022.1.01262.S  all 12m 4   12m_1/2022.1.01262.S/science_goal.uid___A001_X2d20_X137e/group.uid___A001_X2d20_X137f/member.uid___A001_X2d20_X1380/calibrated/uid___A002_X117b2d8_X1635.ms

ESO093         2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X28a/group.uid___A001_X1465_X28b/member.uid___A001_X1465_X28c/calibrated/uid___A002_Xe1baa0_X1e1.ms

ESO208         2017.1.00301.S  all 12m 1   2017.1.00301.S/science_goal.uid___A001_X1284_Xdac/group.uid___A001_X1284_Xdad/member.uid___A001_X1284_Xdae/calibrated/calibrated_final.ms

MCG523         2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X2c2/group.uid___A001_X1465_X2c3/member.uid___A001_X1465_X2c4/calibrated/uid___A002_Xe1baa0_X52bf.ms
MCG523         2019.1.01742.S  all 12m 2   12m/2019.1.01742.S/science_goal.uid___A001_X1465_X2c2/group.uid___A001_X1465_X2c3/member.uid___A001_X1465_X2c6/calibrated/uid___A002_Xe3a5fd_X83c5.ms

NGC1079         2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X28e/group.uid___A001_X1465_X28f/member.uid___A001_X1465_X290/calibrated/uid___A002_Xe1baa0_X2a52.ms
NGC1079         2019.1.01742.S  all 12m 2   12m/2019.1.01742.S/science_goal.uid___A001_X1465_X28e/group.uid___A001_X1465_X28f/member.uid___A001_X1465_X292/calibrated/uid___A002_Xe3da01_X6f2.ms

NGC1375         2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X284/group.uid___A001_X1465_X285/member.uid___A001_X1465_X286/calibrated/uid___A002_Xe1baa0_X36e5.ms
NGC1375         2019.1.01742.S  all 12m 2   12m/2019.1.01742.S/science_goal.uid___A001_X1465_X284/group.uid___A001_X1465_X285/member.uid___A001_X1465_X288/calibrated/uid___A002_Xe3da01_X85a.ms

NGC2110         2016.1.00839.S  all 12m 1   2016.1.00839.S/science_goal.uid___A001_X87d_X302/group.uid___A001_X87d_X303/member.uid___A001_X87d_X304/calibrated/uid___A002_Xc2d675_X1524.ms
NGC2110         2016.1.00839.S  all 12m 4   12m_2/2016.1.00839.S/science_goal.uid___A001_X87d_X302/group.uid___A001_X87d_X303/member.uid___A001_X87d_X306/calibrated/uid___A002_Xca9e6b_X8068.ms
NGC2110         2015.1.00419.S  all 12m 2   12m/2015.1.00419.S/science_goal.uid___A001_X2fb_X747/group.uid___A001_X2fb_X748/member.uid___A001_X2fb_X74b/calibrated/uid___A002_Xb499c3_Xab81.ms.split.cal
NGC2110         2012.1.00474.S  all 12m 3   12m_1/2012.1.00474.S/science_goal.uid___A002_X5d7935_X28d/group.uid___A002_X5d7935_X28e/member.uid___A002_X5d7935_X28f/calibrated/uid___A002_Xa08aa0_X25c.ms.split.cal

NGC3081         2015.1.00086.S  all 12m 1   2015.1.00086.S/science_goal.uid___A001_X2fe_X663/group.uid___A001_X2fe_X664/member.uid___A001_X2fe_X665/calibrated/calibrated_final.ms

NGC3717         2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X2a4/group.uid___A001_X1465_X2a5/member.uid___A001_X1465_X2a6/calibrated/uid___A002_Xe230a1_X41b3.ms
NGC3717         2019.1.01742.S  all 12m 2   12m/2019.1.01742.S/science_goal.uid___A001_X1465_X2a4/group.uid___A001_X1465_X2a5/member.uid___A001_X1465_X2a8/calibrated/uid___A002_Xe3a5fd_X92f1.ms

NGC3783         2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X2cc/group.uid___A001_X1465_X2cd/member.uid___A001_X1465_X2ce/calibrated/uid___A002_Xe230a1_X4461.ms

NGC4235         2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X2c8/group.uid___A001_X1465_X2c9/member.uid___A001_X1465_X2ca/calibrated/uid___A002_Xe1f219_X5a3a.ms

NGC4388         2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X2c8/group.uid___A001_X1465_X2c9/member.uid___A001_X1465_X2ca/calibrated/uid___A002_Xe1f219_X5a3a.ms

NGC5037         2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X26c/group.uid___A001_X1465_X26d/member.uid___A001_X1465_X26e/calibrated/uid___A002_Xe220f2_X3bb.ms
NGC5037         2019.1.01742.S  all 12m 2   12m/2019.1.01742.S/science_goal.uid___A001_X1465_X26c/group.uid___A001_X1465_X26d/member.uid___A001_X1465_X270/calibrated/uid___A002_Xe45e29_Xb752.ms

NGC5506         2017.1.00236.S  all 12m 1   2017.1.00236.S/science_goal.uid___A001_X1296_X8e5/group.uid___A001_X1296_X8e6/member.uid___A001_X1296_X8e7/calibrated/uid___A002_Xc92012_X855a.ms

NGC5845         2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X272/group.uid___A001_X1465_X273/member.uid___A001_X1465_X274/calibrated/uid___A002_Xe1f219_X6963.ms
NGC5845         2019.1.01742.S  all 12m 2   2019.1.01742.S/science_goal.uid___A001_X1465_X272/group.uid___A001_X1465_X273/member.uid___A001_X1465_X274/calibrated/uid___A002_Xe20b32_X4892.ms

NGC6814         2017.1.01439.S  all 12m 1   2017.1.01439.S/science_goal.uid___A001_X1296_X646/group.uid___A001_X1296_X647/member.uid___A001_X1296_X648/calibrated/uid___A002_Xcd8029_Xd9fe.ms

NGC718          2019.1.01742.S  all 12m 1   2019.1.01742.S/science_goal.uid___A001_X1465_X27a/group.uid___A001_X1465_X27b/member.uid___A001_X1465_X27c/calibrated/uid___A002_Xe1baa0_X26a4.ms

NGC7582         2016.1.00254.S  all 12m 1   2016.1.00254.S/science_goal.uid___A001_X87a_X497/group.uid___A001_X87a_X498/member.uid___A001_X87a_X499/calibrated/uid___A002_Xb945f7_X1b14.ms.split.cal
"""
textCO32 = """
NGC4388          2017.1.00082.S  all 12m 1   2017.1.00082.S/science_goal.uid___A001_X1284_X1c48/group.uid___A001_X1284_X1c49/member.uid___A001_X1284_X1c4a/calibrated/uid___A002_Xc89480_X2ad3.ms
NGC4388          2017.1.00082.S  all 12m 2   12m/2017.1.00082.S/science_goal.uid___A001_X1284_X1c48/group.uid___A001_X1284_X1c49/member.uid___A001_X1284_X1c4c/calibrated/uid___A002_Xcc3ae3_X5293.ms
NGC4388          2012.1.00139.S  all 12m 3   12m_1/2012.1.00139.S/science_goal.uid___A002_X5a9a13_Xf3/group.uid___A002_X5a9a13_Xf4/member.uid___A002_X5a9a13_Xf5/calibrated/uid___A002_X828760_X454.ms.split.cal

NGC6814         2017.1.00082.S  all 12m 1   12m_32_1/2017.1.00082.S/science_goal.uid___A001_X1284_X1c42/group.uid___A001_X1284_X1c43/member.uid___A001_X1284_X1c44/calibrated/uid___A002_Xd341ff_X9445.ms.split.cal
NGC6814         2017.1.00082.S  all 12m 2   12m_32_1/2017.1.00082.S/science_goal.uid___A001_X1284_X1c42/group.uid___A001_X1284_X1c43/member.uid___A001_X1284_X1c44/calibrated/uid___A002_Xe014a2_X92b1.ms.split.cal
NGC6814         2017.1.00082.S  all 12m 3   12m_32_2/2017.1.00082.S/science_goal.uid___A001_X1284_X1c42/group.uid___A001_X1284_X1c43/member.uid___A001_X1284_X1c46/calibrated/uid___A002_Xcc3ae3_X12410.ms.split.cal

NGC5728         2019.1.00618.S  all 12m 1   12m_32_1/2019.1.00618.S/science_goal.uid___A001_X1465_X29c6/group.uid___A001_X1465_X29c7/member.uid___A001_X1465_X29ca/calibrated/uid___A002_Xe770d7_X3755.ms.split.cal
NGC5728         2019.1.00618.S  all 12m 2   12m_32_1/2019.1.00618.S/science_goal.uid___A001_X1465_X29c6/group.uid___A001_X1465_X29c7/member.uid___A001_X1465_X29ca/calibrated/uid___A002_Xe78c20_X46c8.ms.split.cal
"""

import os
import re
import warnings
import numpy as np
import csv
from casatools import table, quanta, msmetadata, measures
from astropy.table import Table
from astropy.coordinates import SkyCoord, FK5, ICRS
import astropy.units as u
from astroquery.ned import Ned
import glob
from astropy.io import fits
import analysisUtils as au

# ---------------- user params ----------------
local = False
CO32 = True
restfreq = 230.538  # GHz
if CO32:
    text = textCO32
    restfreq = 345.796  # GHz
vwidth = 1000       # km/s
max_chan_kms = 15.0 # km/s

# CASA tools
tb = table()
qa = quanta()
msmd = msmetadata()
me = measures()

# Input paths / llama table
if local:
    paths = ["/Users/administrator/Astro/casa/ALMA_ARC/2022.1.00401.S/science_goal.uid___A001_X2d20_X2bb4/group.uid___A001_X2d20_X2bb5/member.uid___A001_X2d20_X2bb8/calibrated/uid___A002_X1003af4_Xa540.ms"]
    llamatab = Table.read('/Users/administrator/Astro/llama/llama_main_properties.fits', format='fits')
else:
    basedir = "/data/c3040163/llama/alma/raw"
    llamatab = Table.read('/data/c3040163/llama/llama_main_properties.fits', format='fits')
    paths = []
    for line in text.splitlines():
        line = line.strip()
        if not line or line.startswith("#"):
            continue
        parts = line.split()
        if len(parts) >= 6:
            galaxy_name = parts[0]
            rel_path = parts[0]+'/'+parts[5]
            full_path = os.path.join(basedir, rel_path)
            paths.append((galaxy_name, full_path))
    paths = list(dict.fromkeys(paths))  # preserve order, remove duplicates

# Output CSVs
spw_csv_file = "spw_summary.csv"
field_csv_file = "field_summary.csv"
if CO32:
    spw_csv_file = "spw_summary_CO32.csv"
    field_csv_file = "field_summary_CO32.csv"

with open(spw_csv_file, 'w', newline='') as f:
    writer = csv.writer(f)
    writer.writerow(['name','msname','spw','Centre (GHz)','Width (km/s)','ChanWidth (km/s)',
                     'TotalChans','InLineChans','NonLineChans'])

with open(field_csv_file, 'w', newline='') as f:
    field_writer = csv.writer(f)
    field_writer.writerow(['name','msname','field','distance_kpc'])

# ---------------- helper functions ----------------
def normalize_field_name(s):
    """Robust field name normalization."""
    s = s.upper()
    parts = re.findall(r'\d+|[^\d\s_\-\.]+', s)
    for i, p in enumerate(parts):
        if p.isdigit():
            parts[i] = str(int(p))
    return ''.join(parts)

def ms_frame_from_phase(phase0):
    """Detect MS frame for SkyCoord."""
    try:
        s = me.show(phase0)
        sl = s.lower()
        if 'icrs' in sl: return 'icrs'
        if 'j2000' in sl or 'fk5' in sl: return 'fk5'
        if 'fk4' in sl or 'b1950' in sl: return 'fk4'
        return 'icrs'
    except Exception:
        return 'icrs'

def skycoord_from_phase(phase, frame='fk5'):
    ra_deg = np.degrees(float(phase['m0']['value']))
    dec_deg = np.degrees(float(phase['m1']['value']))
    if frame.lower() == 'fk5':
        return SkyCoord(ra=ra_deg*u.deg, dec=dec_deg*u.deg, frame=FK5(equinox='J2000'))
    elif frame.lower() == 'icrs':
        return SkyCoord(ra=ra_deg*u.deg, dec=dec_deg*u.deg, frame=ICRS())
    else:
        return SkyCoord(ra=ra_deg*u.deg, dec=dec_deg*u.deg, frame=FK5(equinox='J2000'))

# ---------------- main loop ----------------
for name, ms_path in paths:
    print('-'*30, name, '-'*30)
    msname = os.path.basename(ms_path)
    row = llamatab[llamatab['id'] == name]
    if len(row) == 0:
        print(f"⚠️ No entry '{name}' in llama table. Skipping {msname}")
        continue

    z = float(row['redshift'][0]) if 'redshift' in row.colnames else 0
    D_Mpc = float(row['D [Mpc]'][0])
    target_ra_deg = float(row['RA (deg)'][0])
    target_dec_deg = float(row['DEC (deg)'][0])
    target_coord_catalog = SkyCoord(ra=target_ra_deg*u.deg, dec=target_dec_deg*u.deg, frame=FK5(equinox='J2000'))
    f_hz = restfreq*1e9 / (1+z)  # observed frequency
    vhalf_hz = (vwidth/2) * f_hz / 3e5  # convert km/s to Hz

    # ---------- SPW analysis ----------
    spw_table = os.path.join(ms_path, "SPECTRAL_WINDOW")
    print(f"MS: {ms_path}")
    try:
        tb.open(spw_table)
        n_spw = tb.nrows()
        ref_freqs = tb.getcol("REF_FREQUENCY")
    except Exception as e:
        print(f"Error opening {spw_table}: {e}")
        tb.close()
        continue

    spw_written = 0
    for spw_id in range(n_spw):
        try:
            freqs = np.ravel(tb.getcell("CHAN_FREQ", spw_id))
            widths = np.ravel(tb.getcell("CHAN_WIDTH", spw_id))
        except Exception as e:
            print(f"  Could not read SPW {spw_id}: {e}")
            continue

        minf, maxf = freqs.min(), freqs.max()


        if minf <= f_hz <= maxf:
            width_hz = maxf - minf
            ch_width_hz = abs(widths[0])
            width_kms = 3e5 * width_hz / f_hz
            ch_width_kms = 3e5 * ch_width_hz / f_hz
            

            if ch_width_kms <= max_chan_kms:
                total_chans = len(freqs)
                print('spwmin',minf/1e9,'spwmax', maxf/1e9)

                
                line_mask = (freqs >= f_hz - vhalf_hz) & (freqs <= f_hz + vhalf_hz)
                print('line_freq',f_hz/1e9,'half vwidth',vhalf_hz/1e9)
                line_chans = np.sum(line_mask)
                non_line_chans = total_chans - line_chans

                print(f"  SPW {spw_id} | Centre {ref_freqs[spw_id]/1e9:.5f} GHz | "
                    f"Width {width_kms:.2f} km/s | Chan {ch_width_kms:.2f} km/s | "
                    f"Line chans: {line_chans}, Non-line chans: {non_line_chans}")

                with open(spw_csv_file, 'a', newline='') as f:
                    writer = csv.writer(f)
                    writer.writerow([name, msname, spw_id, ref_freqs[spw_id]/1e9,
                                    width_kms, ch_width_kms, total_chans,
                                    line_chans, non_line_chans])

                spw_written += 1
            else:
                print(f"  SPW {spw_id} skipped (chan width {ch_width_kms:.2f} km/s >= max {max_chan_kms} km/s)")
    tb.close()
    if spw_written == 0:
        print(f"⚠️ No SPWs added for MS {msname}")

    # ---------- FIELD summary ----------
    print(f"Processing fields for {msname} ...")
    try:
        msmd.open(ms_path)
        nfields = msmd.nfields()
        if nfields == 0:
            print(f"⚠️ MS {msname} has no fields.")
            msmd.close()
            continue

        # -------------------- MATCH FIELD NAME --------------------
        # Normalize target field name
        field_entry = llamatab[llamatab['id'] == name]['name'][0]
        field_norm = normalize_field_name(field_entry)
        print(field_norm, "normalized target field name")

        # Open MS metadata
        msmd.open(ms_path)
        nfields = msmd.nfields()
        if nfields == 0:
            print(f"⚠️ MS {msname} has no fields.")
            msmd.close()
            continue

        # Detect MS frame
        phase0 = msmd.phasecenter(0)
        ms_frame_name = ms_frame_from_phase(phase0)
        print(f"Detected MS frame: {ms_frame_name}")
        ms_frame = FK5(equinox='J2000') if ms_frame_name.lower() == 'fk5' else ICRS()

        # Build target SkyCoord in MS frame
        catalog_frame = FK5(equinox='J2000')
        target_coord_catalog = SkyCoord(ra=target_ra_deg*u.deg,
                                        dec=target_dec_deg*u.deg,
                                        frame=catalog_frame)
        try:
            target_coord = target_coord_catalog.transform_to(ms_frame)
        except Exception:
            target_coord = target_coord_catalog

        # Get MS field names
        ms_field_names = msmd.fieldnames()

        # --- Try direct match first ---
        fname_match = None
        for f in ms_field_names:
            if normalize_field_name(f) == field_norm:
                fname_match = f
                break

        # --- If no direct match, try NED aliases ---
        if fname_match is None:
            print(f"No direct field match for {field_entry} in {msname}. Trying NED aliases...")
            try:
                with warnings.catch_warnings():
                    warnings.simplefilter("ignore")
                    Ned_table = Ned.query_object(field_entry)  # query NED directly
                if Ned_table is not None and len(Ned_table) > 0:
                    # Extract possible aliases
                    aliases = []
                    if 'Object Name' in Ned_table.colnames:
                        aliases += [str(n) for n in Ned_table['Object Name']]
                    if 'Object Designation' in Ned_table.colnames:
                        aliases += [str(n) for n in Ned_table['Object Designation']]

                    for alt in aliases:
                        alt_norm = normalize_field_name(alt)
                        for f in ms_field_names:
                            if normalize_field_name(f) == alt_norm:
                                fname_match = f
                                print(f"Matched via NED alias: {alt} → {fname_match}")
                                break
                        if fname_match:
                            break
                else:
                    print(f"No aliases found in NED for {field_entry}")

            except Exception as e:
                print(f"NED lookup failed for {field_entry}: {e}")

        if fname_match is None:
            print(f"⚠️ No matching field found for {field_entry} or its aliases in {msname}. Skipping fields.")
            msmd.close()
            continue

        print(f"Matched field: {fname_match}")

        # ---------- Compute separations ----------
        for field_id in range(nfields):
            fname = msmd.namesforfields([field_id])[0]
            if normalize_field_name(fname) != normalize_field_name(fname_match):
                continue

            phase = msmd.phasecenter(field_id)
            field_coord = skycoord_from_phase(phase, frame=ms_frame_name)
            sep_kpc = field_coord.separation(target_coord_catalog).deg * (D_Mpc*1000)/180*np.pi
            with open(field_csv_file, 'a', newline='') as f:
                field_writer = csv.writer(f)
                field_writer.writerow([name, msname, field_id, f"{sep_kpc:.3f}"])
            print(f"  Field {field_id} ({fname}): distance from target = {sep_kpc:.3f} kpc")

        msmd.close()


    except Exception as e:
        print(f"Error processing fields in {msname}: {e}")
        msmd.close()
        continue






print("Done.")
